# 法律咨询助手系统需求文档

## 1. 项目概述

### 1.1 项目背景

开发一个基于AI的法律咨询助手系统,为用户提供智能化的法律咨询服务,包括法律问答、风险评估、争议焦点分析、案件分析等功能。

### 1.2 技术栈

- **后端框架**: Spring Boot 3.x
- **数据库**: MySQL 8.x
- **缓存**: Redis
- **对象存储**: MinIO
- **向量数据库**: Milvus
- **AI框架**: AgentScope
- **ORM**: MyBatis Plus

### 1.3 系统目标

- 提供统一的智能问答接口,支持多种AI模型和Agent类型
- 实现文档智能解析和知识库管理
- 支持会话管理和分享功能
- 提供流式输出和控制能力

## 2. 功能需求

### 2.1 用户认证与授权

#### 2.1.1 功能描述

提供基于手机号和验证码的用户登录/注册功能,以及基于Token的身份认证机制。

#### 2.1.2 核心功能

**手机号验证码登录/注册:**

- 用户输入手机号和验证码进行登录
- 如果数据库中不存在该手机号对应的账号,系统自动创建新账号(默认注册)
- 验证码通过短信服务发送,有效期5分钟
- 验证码验证成功后,系统生成并返回Token

**Token认证机制:**

- 登录成功后,系统生成JWT Token返回给客户端
- Token包含用户ID、手机号等基本信息
- Token有效期: 7天(可配置)
- 客户端在请求头中携带Token: `Authorization: Bearer {token}`
- 需要认证的接口必须验证Token有效性
- 部分公开接口(如分享链接访问)无需Token验证

**Token刷新机制:**

- Token即将过期时,客户端可请求刷新Token
- 刷新Token有效期: 30天
- 刷新成功后返回新的访问Token

#### 2.1.3 业务规则

- 验证码发送频率限制: 同一手机号1分钟内只能发送1次,每天最多发送10次
- Token存储在Redis中,支持主动失效(如用户注销、修改密码等)
- 验证码存储在Redis中,5分钟自动过期
- 登录成功后更新用户的最后登录时间和最后登录IP
- 新用户注册时,自动生成默认昵称(如: 用户+手机号后4位)

### 2.2 用户信息管理

#### 2.2.1 功能描述

提供用户个人信息的管理功能,包括查看、编辑个人信息和账号注销。

#### 2.2.2 核心功能

**查看个人信息:**

- 获取当前登录用户的完整信息
- 返回字段包括: 昵称、手机号、头像URL、个人简介、创建时间等

**编辑个人信息:**

- 支持修改昵称、头像、个人简介
- 手机号不支持修改(如需修改需通过客服)
- 头像支持上传图片文件,自动存储到MinIO
- 所有修改需要Token认证

**账号注销:**

- 用户可申请注销账号
- 注销操作需要二次确认(如输入手机号验证码)
- 注销后:
  - 账号状态标记为已删除
  - 用户数据软删除,保留30天后物理删除
  - 关联的会话、文件等数据一并处理
  - Token立即失效

#### 2.2.3 业务规则

- 昵称长度限制: 2-20个字符,支持中文、英文、数字
- 个人简介长度限制: 最多500个字符
- 头像文件大小限制: 最大5MB,支持jpg、png、webp格式
- 头像自动压缩和裁剪,生成不同尺寸的缩略图
- 账号注销后30天内可申请恢复(需联系客服)

### 2.3 统一问答接口

#### 2.1.1 功能描述

提供一个统一的智能问答接口,支持多种配置和功能选项。

#### 2.1.2 核心功能

**输入参数:**

- `question`: 用户提问内容(必填)

- `fileIds`: 绑定的文件ID集合(可选,支持多个文件)

- `deepThinking`: 深度思考模式开关(布尔值)

- ```
  modelType
  ```

  : 模型类型(枚举值)

  - `DEEPSEEK_CHAT`: deepseek-chat
  - `DEEPSEEK_REASONER`: deepseek-reasoner

- `temperature`: 温度参数(浮点数,范围0.0-2.0,默认0.7)

- ```
  agentType
  ```

  : Agent类型(枚举值)

  - `LEGAL_CONSULTATION`: 普通法律咨询
  - `RISK_ASSESSMENT`: 风险评估
  - `DISPUTE_FOCUS`: 争议焦点
  - `CASE_ANALYSIS`: 案件分析
  - 预留扩展能力

- `knowledgeBaseId`: 知识库ID(可选)

- `conversationId`: 会话ID(可选,用于延续对话)

- `autoGenerateTitle`: 自动生成标题(布尔值,首次对话时使用)

**输出格式:**

- 流式输出(SSE - Server-Sent Events)
- 响应内容包括:
  - `messageId`: 消息ID
  - `content`: 回答内容(流式)
  - `generatedTitle`: 自动生成的标题(如果启用)
  - `conversationId`: 会话ID
  - `status`: 状态(thinking/streaming/completed/error)

#### 2.1.3 业务规则

- 如果绑定了文件,需要从知识库中检索相关内容
- 深度思考模式下,需要增加思考链路的展示
- 首次对话时,根据用户提问自动生成会话标题
- 支持上下文记忆,关联conversationId
- 温度参数影响回答的创造性程度

### 2.4 文件上传接口

#### 2.2.1 功能描述

支持多种格式文件上传,并自动解析提取内容存储到MinIO和向量数据库。

#### 2.2.2 支持的文件格式

**文档类:**

- PDF (.pdf)
- Word (.doc, .docx)
- 文本 (.txt)
- Excel (.xls, .xlsx)
- PowerPoint (.ppt, .pptx)
- WPS 格式

**图片类:**

- JPEG (.jpg, .jpeg)
- PNG (.png)
- BMP (.bmp)
- GIF (.gif)
- TIFF (.tiff)
- WebP (.webp)

#### 2.2.3 处理流程

**文档处理:**

1. 接收文件上传
2. 验证文件格式和大小
3. 将文件存储到MinIO
4. 提取文档内容转换为Markdown格式
5. 对文档中的图片进行OCR识别
6. 将Markdown内容存储到MinIO
7. 生成文本向量存入Milvus
8. 保存文件元数据到MySQL

**图片处理:**

1. 接收图片上传
2. 存储原始图片到MinIO
3. 使用OCR提取图片中的文字内容
4. 将提取的文本转换为Markdown
5. 生成向量存入Milvus
6. 保存文件元数据到MySQL

#### 2.2.4 输入输出

**输入参数:**

- `file`: 上传的文件(MultipartFile)
- `knowledgeBaseId`: 所属知识库ID(可选)
- `description`: 文件描述(可选)

**输出响应:**

- `fileId`: 文件唯一标识
- `fileName`: 文件名称
- `fileType`: 文件类型
- `fileSize`: 文件大小
- `uploadTime`: 上传时间
- `status`: 处理状态(uploading/processing/completed/failed)
- `extractedText`: 提取的文本预览(前500字符)

### 2.5 流式输出控制接口

#### 2.3.1 停止流式输出

- **接口**: `/api/conversation/stop`
- **方法**: POST
- **参数**: `messageId` - 消息ID
- **功能**: 立即停止指定消息的流式输出

#### 2.3.2 恢复流式输出

- **接口**: `/api/conversation/resume`
- **方法**: POST
- **参数**: `messageId` - 消息ID
- **功能**: 从断点处恢复流式输出
- **说明**: 需要在Redis中保存输出进度

### 2.6 会话管理

#### 2.4.1 创建会话

- 自动创建或手动创建
- 自动生成或自定义标题

#### 2.4.2 会话列表

- 分页查询用户的所有会话
- 支持按时间、置顶状态排序
- 显示会话基本信息(标题、创建时间、最后更新时间、消息数量)

#### 2.4.3 会话重命名

- **接口**: `/api/conversation/rename`

- 参数

  :

  - `conversationId`: 会话ID
  - `newTitle`: 新标题

#### 2.4.4 会话置顶

- **接口**: `/api/conversation/pin`

- 参数

  :

  - `conversationId`: 会话ID
  - `pinned`: 是否置顶(布尔值)

- **规则**: 置顶的会话在列表中优先显示

#### 2.4.5 会话删除

- **接口**: `/api/conversation/delete`

- **参数**: `conversationId`: 会话ID

- 规则

  :

  - 软删除,保留数据30天
  - 删除会话的同时删除关联的所有消息

#### 2.4.6 会话分享

- **接口**: `/api/conversation/share`

- 参数

  :

  - `conversationId`: 会话ID
  - `expirationTime`: 过期时间(可选,默认7天)
  - `password`: 访问密码(可选)

- 输出

  :

  - `shareId`: 分享唯一标识
  - `shareUrl`: 分享链接
  - `expirationTime`: 过期时间
  - `hasPassword`: 是否设置密码

**分享访问接口:**

- **接口**: `/api/share/{shareId}`

- **方法**: GET/POST

- **参数**: `password` - 访问密码(如果设置了密码)

- **功能**: 查看分享的会话内容

- 规则

  :

  - 验证分享是否过期
  - 如果设置了密码,需要验证密码
  - 只读模式,不能进行问答操作

## 3. 非功能需求

### 3.1 性能要求

- 问答接口响应时间: 首字响应 < 2秒
- 文件上传处理: 小文件(<10MB) < 30秒,大文件(<100MB) < 5分钟
- 并发支持: 支持100+并发用户
- 流式输出延迟: < 100ms

### 3.2 安全要求

- **认证机制**: 基于JWT Token的身份认证,大部分接口需要Token验证
- **公开接口**: 分享链接访问等公开接口无需Token验证,但需要验证分享密码(如设置)
- **Token安全**: Token采用HS256算法签名,密钥定期轮换,支持Token黑名单机制
- **验证码安全**: 验证码6位数字,5分钟有效期,防暴力破解(错误次数限制)
- **密码安全**: 账号注销等敏感操作需要二次验证
- **文件安全**: 文件上传需要病毒扫描和格式验证
- **数据安全**: 敏感信息加密存储(如手机号脱敏显示)
- **防护措施**: 防止SQL注入、XSS攻击、CSRF攻击
- **API限流**: 接口级别限流保护,防止恶意请求
- **IP记录**: 记录用户登录IP,异常登录行为告警

### 3.3 可用性要求

- 系统可用性: 99.9%
- 数据备份: 每日备份
- 错误恢复: 支持断点续传和重试机制

### 3.4 扩展性要求

- Agent类型可动态扩展
- 支持新增AI模型
- 知识库容量可扩展
- 支持分布式部署

## 4. 数据模型设计

### 4.1 核心实体

#### 用户表 (user)

- id: 主键,自增
- nickname: 昵称,默认"用户+手机号后4位"
- phone: 手机号,唯一索引,不可修改
- avatar: 头像URL,存储MinIO路径
- bio: 个人简介,最多500字符
- is_enabled: 是否可用,布尔值,默认true(用于账号封禁)
- is_deleted: 是否删除,布尔值,默认false(软删除标记)
- created_at: 创建时间,时间戳
- updated_at: 更新时间,时间戳
- last_login_at: 最后登录时间,时间戳
- last_login_ip: 最后登录IP,字符串

**索引设计:**
- 主键索引: id
- 唯一索引: phone
- 普通索引: is_deleted, created_at

#### 会话表 (conversation)

- id: 主键
- user_id: 用户ID
- title: 会话标题
- agent_type: Agent类型
- model_type: 使用的模型
- is_pinned: 是否置顶
- is_deleted: 是否删除
- created_at: 创建时间
- updated_at: 更新时间
- deleted_at: 删除时间

#### 消息表 (message)

- id: 主键
- conversation_id: 会话ID
- role: 角色(user/assistant)
- content: 消息内容
- file_ids: 关联的文件ID(JSON)
- parameters: 参数配置(JSON)
- status: 状态
- created_at: 创建时间

#### 文件表 (file)

- id: 主键
- user_id: 用户ID
- knowledge_base_id: 知识库ID
- file_name: 文件名
- file_type: 文件类型
- file_size: 文件大小
- minio_path: MinIO存储路径
- markdown_path: Markdown文件路径
- status: 处理状态
- created_at: 上传时间

#### 分享表 (share)

- id: 主键
- conversation_id: 会话ID
- share_id: 分享唯一标识
- password_hash: 密码哈希
- expiration_time: 过期时间
- view_count: 查看次数
- created_at: 创建时间

#### 知识库表 (knowledge_base)

- id: 主键
- user_id: 用户ID
- name: 知识库名称
- description: 描述
- file_count: 文件数量
- created_at: 创建时间

## 5. 接口清单

### 5.1 用户认证相关

- POST `/api/auth/send-code` - 发送验证码(无需Token)
- POST `/api/auth/login` - 手机号验证码登录/注册(无需Token)
- POST `/api/auth/refresh` - 刷新Token(需要Token)
- POST `/api/auth/logout` - 退出登录(需要Token)

**说明:** 登录接口如果账号不存在会自动注册,返回Token

### 5.2 用户信息相关

- GET `/api/user/info` - 获取当前用户信息(需要Token)
- PUT `/api/user/info` - 更新用户信息(需要Token)
- POST `/api/user/avatar` - 上传头像(需要Token)
- POST `/api/user/deactivate` - 注销账号(需要Token,需要二次验证)

### 5.3 问答相关

- POST `/api/chat/ask` - 统一问答接口(SSE)
- POST `/api/chat/stop` - 停止输出
- POST `/api/chat/resume` - 恢复输出

### 5.4 文件相关

- POST `/api/file/upload` - 上传文件
- GET `/api/file/list` - 文件列表
- DELETE `/api/file/{fileId}` - 删除文件
- GET `/api/file/{fileId}/content` - 获取文件内容

### 5.5 会话相关

- POST `/api/conversation/create` - 创建会话
- GET `/api/conversation/list` - 会话列表
- PUT `/api/conversation/{conversationId}/rename` - 重命名
- PUT `/api/conversation/{conversationId}/pin` - 置顶/取消置顶
- DELETE `/api/conversation/{conversationId}` - 删除会话
- GET `/api/conversation/{conversationId}/messages` - 获取消息历史
- POST `/api/conversation/{conversationId}/share` - 分享会话

### 5.6 分享相关

- GET `/api/share/{shareId}` - 访问分享
- POST `/api/share/{shareId}/verify` - 验证密码

### 5.7 知识库相关

- POST `/api/knowledge-base/create` - 创建知识库
- GET `/api/knowledge-base/list` - 知识库列表
- DELETE `/api/knowledge-base/{id}` - 删除知识库

## 6. 优先级划分

### P0 (核心功能,第一期必须完成)

- **用户认证与授权**
  - 手机号验证码登录/注册
  - Token生成和验证
  - 用户信息管理(查看、编辑)
- 统一问答接口基础功能
- 文件上传和解析(PDF、TXT)
- 会话管理基础功能
- 基础的法律咨询Agent

### P1 (重要功能,第二期完成)

- **用户功能增强**
  - 账号注销功能
  - Token刷新机制
  - 登录IP记录和异常检测
- 深度思考模式
- 完整的文件格式支持
- OCR图片识别
- 流式输出控制
- 会话分享功能

### P2 (增强功能,第三期完成)

- 多种Agent类型扩展
- 知识库管理优化
- 性能优化和监控
- 高级搜索和过滤

## 7. 验收标准

- 所有P0功能正常运行,无阻塞性bug
- 接口响应时间符合性能要求
- 通过安全审计
- 完成单元测试覆盖率 > 80%
- 完成集成测试
- 完成用户验收测试