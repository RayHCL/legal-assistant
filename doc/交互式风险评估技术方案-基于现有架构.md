# 交互式风险评估技术方案（基于现有架构）

## 文档信息
- **版本**: v1.0
- **创建日期**: 2026-01-20
- **架构原则**: 不破坏现有架构体系，最小化改动
- **状态**: 设计阶段

---

## 目录
1. [现有架构分析](#1-现有架构分析)
2. [设计原则](#2-设计原则)
3. [技术方案](#3-技术方案)
4. [实施步骤](#4-实施步骤)
5. [代码实现](#5-代码实现)
6. [前端配合](#6-前端配合)
7. [测试验证](#7-测试验证)

---

## 1. 现有架构分析

### 1.1 架构分层

```
┌─────────────────────────────────────────────────────────┐
│                    Controller 层                         │
│              ChatController (流式对话接口)               │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    Service 层                            │
│           ChatService (对话逻辑、会话管理)               │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    Factory 层                            │
│        LegalAgentFactory (Agent工厂创建)                │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    Agent 层                              │
│  ReactLegalAgent (基类)                                   │
│  ├─ RiskAssessmentAgent      (风险评估 Agent)           │
│  ├─ LegalConsultationAgent   (法律咨询 Agent)           │
│  ├─ DisputeFocusAgent        (争议焦点 Agent)           │
│  └─ CaseAnalysisAgent        (案件分析 Agent)           │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    Tools 层                              │
│  FileToolService  |  DateToolService  |  [新增工具]     │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    数据层                                │
│  Conversation | Message | DocumentFile | MySQL | MinIO  │
└─────────────────────────────────────────────────────────┘
```

### 1.2 现有数据流

```
用户请求
   ↓
ChatController.chatCompletion()
   ↓
ChatService.createChatStream()
   ├─ 创建/获取 Conversation
   ├─ 保存用户消息到 Message 表
   ├─ LegalAgentFactory.createAgent()
   ├─ ReActAgent.stream() (流式输出)
   └─ 保存助手消息到 Message 表
   ↓
SSE 流式响应返回前端
```

### 1.3 现有 RiskAssessmentAgent 分析

**当前实现：**
- 一次性输出完整风险评估报告
- 包含：我方信息、对方信息、案由、核心诉求、基本事实、证据、风险等级、优势分析、风险提示、行动建议等
- 温度参数：0.3（较低，保证输出稳定性）

**问题：**
- 信息过载，用户难以消化
- 缺乏交互，无法根据用户反馈调整
- 固定格式，灵活性不足

---

## 2. 设计原则

### 2.1 核心原则

| 原则 | 说明 | 实现方式 |
|------|------|---------|
| **架构兼容** | 不破坏现有架构 | 复用现有Controller、Service、Factory |
| **最小改动** | 只修改必要部分 | 仅改动Agent提示词和工具 |
| **向后兼容** | 不影响现有功能 | 新增交互模式，保留原有模式 |
| **渐进增强** | 支持平滑升级 | 通过参数控制交互/报告模式 |

### 2.2 不改动的部分

✅ **保持不变：**
- ChatController - 统一对话入口
- ChatService - 流式对话逻辑
- LegalAgentFactory - Agent工厂
- ReactLegalAgent 基类
- Conversation/Message 实体
- FileToolService, DateToolService 工具

### 2.3 需要修改的部分

🔧 **需要改动：**
1. **RiskAssessmentAgent 提示词** - 改为交互式流程
2. **ChatCompletionRequest** - 新增可选参数 `interactiveMode`
3. **前端界面** - 提供快捷操作按钮

---

## 3. 技术方案

### 3.1 方案概述

**核心思想：** 利用 AgentScope 的 ReAct 机制和现有会话系统，通过**提示词工程**实现交互式评估，无需新增服务层。

**实现方式：**
1. 用户发起风险评估请求时，携带 `interactiveMode: true` 参数
2. RiskAssessmentAgent 使用交互式提示词，分阶段与用户对话
3. 利用现有 Message 表保存上下文历史
4. Agent 根据用户输入动态调整后续对话
5. 用户明确要求时才生成完整报告

### 3.2 交互流程设计

```
用户: "我想评估合同风险" [interactiveMode=true]
   ↓
Agent: 阶段1 - 需求确认
   "您好！我可以帮您进行交互式风险评估。
    请问您想评估什么类型？[合同风险/合规审查/诉讼风险]
    最关心哪些方面？[付款条款/违约责任/争议解决]"
   ↓
User: "合同风险，关心付款条款和违约责任" [上传文件]
   ↓
Agent: 阶段2 - 信息收集
   [调用 getFileContent 工具读取文件]
   "收到文档。让我先快速浏览一下...
    为了更准确评估，还需要了解：
    1. 交易金额大概是多少？
    2. 您在交易中的角色？[买方/卖方]"
   ↓
User: "金额50万，我是买方"
   ↓
Agent: 阶段3 - 初步分析
   "📊 风险快速评估
    🚨 风险等级: 中等 (65/100)
    ⚠️ 关键发现:
    1. 付款条款存在风险 - 约定分3期但未明确具体日期
    2. 违约金比例约定不明确
    3. 争议解决条款较完善 ✅

    您想深入了解哪个方面？"
   ↓
User: "详细分析付款条款"
   ↓
Agent: 阶段4 - 交互深入
   "📄 付款条款详细分析
    🔍 当前约定: 「甲方应分三期向乙方支付款项...」
    ⚠️ 风险点: [具体风险]
    💡 改进建议: [具体建议]

    还有其他想了解的吗？
    如果没有，我可以为您生成完整报告。"
   ↓
User: "生成报告"
   ↓
Agent: 阶段5 - 报告生成
   [调用生成报告提示词，输出完整报告]
```

### 3.3 技术实现要点

#### 3.3.1 利用现有会话机制

```java
// 现有 Message 表自动保存对话历史
// Message.conversationId 相同的消息属于同一会话
// Agent 可以通过历史上下文理解之前的对话

Message 1 (User):    "我想评估合同风险"
Message 2 (Agent):   "您好！请问您想评估什么类型？..."
Message 3 (User):    "合同风险，关心付款条款"
Message 4 (Agent):   "收到文档。交易金额是多少？"
Message 5 (User):    "金额50万，我是买方"
Message 6 (Agent):   "📊 风险快速评估..."
```

#### 3.3.2 利用现有工具

```java
// 现有工具已注册到 ReactLegalAgent
// RiskAssessmentAgent 继承后自动获得

1. FileToolService.getFileContent(fileId)
   - Agent 在阶段2调用，获取文档内容

2. DateToolService.getCurrentTime(timezone)
   - Agent 在报告生成时调用，获取当前日期
```

#### 3.3.3 提示词分阶段设计

```
系统提示词 = 基础原则 + 5个阶段提示词

基础原则:
- 用户主导、渐进式交互、信息分层、可视化呈现

阶段提示词:
- 阶段1: 需求确认
- 阶段2: 信息收集
- 阶段3: 初步分析
- 阶段4: 交互深入
- 阶段5: 报告生成
```

#### 3.3.4 参数控制模式

```java
// ChatCompletionRequest 新增参数
private Boolean interactiveMode = false;  // 默认false，保持原有行为

// RiskAssessmentAgent 根据参数选择提示词
if (interactiveMode) {
    return INTERACTIVE_PROMPT;  // 交互式提示词
} else {
    return ORIGINAL_PROMPT;     // 原有一次性报告提示词
}
```

---

## 4. 实施步骤

### 4.1 后端改动（最小化）

#### 步骤1: 扩展请求参数

```java
// ChatCompletionRequest.java
@Schema(description = "是否启用交互式模式", example = "false")
private Boolean interactiveMode;
```

#### 步骤2: 修改 RiskAssessmentAgent

```java
// RiskAssessmentAgent.java
@Override
public String getSystemPrompt() {
    // TODO: 从配置或参数获取 interactiveMode
    // 暂时返回交互式提示词
    return INTERACTIVE_SYSTEM_PROMPT;
}

private String getInteractivePrompt() {
    return """
        你是一个交互式法律风险评估专家...

        ## 评估流程（5个阶段）
        ### 阶段1: 需求确认
        ### 阶段2: 信息收集
        ### 阶段3: 初步分析
        ### 阶段4: 交互深入
        ### 阶段5: 报告生成
        ...
        """;
}
```

#### 步骤3: 传递参数到 Agent

```java
// ChatService.java - createChatStream 方法
// 在创建 Agent 时，传递 interactiveMode 参数

// 方案A: 通过 Conversation 的 parameters 字段传递
conversation.setParameters("{\"interactiveMode\":true}");

// 方案B: 在 ChatCompletionRequest 中传递
// Agent 通过 ThreadLocal 或其他方式获取
```

### 4.2 前端配合（可选增强）

#### 快捷操作按钮

```jsx
// 交互模式下显示快捷按钮
{isInteractiveMode && (
  <div className="quick-actions">
    <button onClick={() => sendMessage("跳过")}>跳过此问题</button>
    <button onClick={() => sendMessage("生成报告")}>直接生成报告</button>
    <button onClick={() => sendMessage("返回")}>返回上一步</button>
  </div>
)}
```

### 4.3 实施优先级

| 优先级 | 任务 | 工作量 | 说明 |
|--------|------|--------|------|
| P0 | 修改 Agent 提示词 | 2小时 | 核心改动 |
| P1 | 前端快捷操作 | 1小时 | 提升用户体验 |
| P2 | 参数化控制 | 1小时 | 支持模式切换 |
| P3 | 新增工具 | 2小时 | 增强功能（可选） |

---

## 5. 代码实现

### 5.1 修改 ChatCompletionRequest

```java
package com.legal.assistant.dto.request;

import com.legal.assistant.enums.AgentType;
import com.legal.assistant.enums.ModelType;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.Data;

import java.util.List;

/**
 * 对话完成请求
 */
@Data
@Schema(description = "对话完成请求")
public class ChatCompletionRequest {

    @Schema(description = "用户问题", required = true, example = "什么是合同纠纷？")
    @NotBlank(message = "问题不能为空")
    private String question;

    @Schema(description = "文件ID列表", example = "[1, 2, 3]")
    private List<Long> fileIds;

    @Schema(description = "模型类型", required = true, example = "DASHSCOPE_QWEN_MAX")
    @NotNull(message = "模型类型不能为空")
    private ModelType modelType;

    @Schema(description = "Agent类型", required = true, example = "LEGAL_CONSULTATION")
    @NotNull(message = "Agent类型不能为空")
    private AgentType agentType;

    @Schema(description = "温度参数 (0.0-2.0)", example = "0.7")
    private Double temperature;

    @Schema(description = "知识库ID列表", example = "[1, 2]")
    private List<Long> knowledgeBaseIds;

    @Schema(description = "会话ID（延续对话）", example = "1")
    private Long conversationId;

    @Schema(description = "是否自动生成标题", example = "true")
    private Boolean autoGenerateTitle;

    @Schema(description = "是否启用深度思考", example = "false")
    private Boolean deepThinking;

    // ========== 新增参数 ==========

    @Schema(description = "是否启用交互式模式（仅风险评估支持）", example = "true")
    private Boolean interactiveMode;
}
```

### 5.2 修改 RiskAssessmentAgent

```java
package com.legal.assistant.agents.impl;

import com.legal.assistant.enums.AgentType;
import com.legal.assistant.agents.base.ReactLegalAgent;
import org.springframework.stereotype.Component;

/**
 * 风险评估Agent - 支持交互式评估模式
 */
@Component
public class RiskAssessmentAgent extends ReactLegalAgent {

    @Override
    public AgentType getAgentType() {
        return AgentType.RISK_ASSESSMENT;
    }

    @Override
    public String getSystemPrompt() {
        // 默认使用交互式提示词
        // 如需使用原有报告模式，可通过参数控制
        return INTERACTIVE_SYSTEM_PROMPT;
    }

    /**
     * 交互式系统提示词
     */
    private static final String INTERACTIVE_SYSTEM_PROMPT = """
            你是一个交互式法律风险评估专家，名为"法律助手"。

            ## 核心原则
            1. **用户主导** - 让用户决定评估方向和深度
            2. **渐进式交互** - 分阶段收集信息，逐步深入
            3. **信息分层** - 先给概览，再给详情
            4. **可视化呈现** - 使用结构化输出，避免大段文字
            5. **主动引导** - 适时询问用户需求，不要等用户提问

            ## 评估流程（严格遵循5个阶段）

            ### 【阶段1】需求确认
            目标：了解用户想评估什么，关注哪些方面

            行动：
            - 询问评估类型（合同风险/合规审查/诉讼风险等）
            - 了解用户关注的重点领域
            - 收集必要的文档

            输出示例：
            "您好！我可以帮您进行交互式法律风险评估。

             请问您想评估什么？
             1. 合同风险
             2. 合规审查
             3. 诉讼风险

             您最关心哪些方面？
             【付款条款】【违约责任】【争议解决】【其他】"

            ### 【阶段2】信息收集
            目标：收集评估所需的关键信息

            行动：
            - 使用 getFileContent(fileId) 工具读取用户上传的文档
            - 根据文档内容动态生成后续问题
            - 每轮只问 2-3 个问题

            输出示例：
            "收到文档。让我先快速浏览一下...
             [调用工具获取文件内容]

             为了更准确地评估，我还需要了解：
             1. 这份合同的交易金额大概是多少？
             2. 您在交易中的角色是买方还是卖方？"

            ### 【阶段3】初步分析
            目标：快速给出风险概览

            行动：
            - 基于收集的信息进行快速评估
            - 给出风险等级和评分
            - 列出 3 个关键发现
            - 使用 emoji 标记风险程度

            风险等级表示：
            🚨 高风险 (70-100分)
            ⚡ 中风险 (40-69分)
            ✅ 低风险 (0-39分)

            输出格式：
            "📊 风险快速评估

             🚨 风险等级: 中等 (风险评分: 65/100)

             ⚠️ 关键发现:
             1. 付款条款存在风险 - 约定分3期但未明确具体日期
             2. 违约金比例约定不明确 - 可能导致追责困难
             3. 争议解决条款较完善 ✅

             您想深入了解哪个方面？还是继续评估其他风险点？"

            ### 【阶段4】交互深入
            目标：根据用户兴趣深入分析特定方面

            行动：
            - 针对用户选择的方面进行详细分析
            - 引用具体条款内容
            - 解释风险产生的原因
            - 提供具体的改进建议
            - 询问是否需要继续深入了解其他方面

            输出格式：
            "📄 付款条款详细分析

             🔍 当前约定:
             「甲方应分三期向乙方支付款项...」

             ⚠️ 风险点:
             • 未约定每期付款的具体日期
             • 未约定逾期付款的违约责任
             • 缺少付款条件（如验收标准）

             💡 改进建议:
             建议补充:
             1. 明确每期付款的具体时间节点
             2. 约定逾期付款的违约金计算方式
             3. 设置付款前提条件

             还有其他想了解的吗？"

            ### 【阶段5】报告生成
            目标：生成完整评估报告（仅在用户明确要求时）

            触发条件：
            - 用户说"生成报告"、"完整报告"、"出具报告"
            - 用户说"好的"、"可以"、"OK"等表示满意的词

            输出格式：
            "好的，为您生成完整的风险评估报告。

             <content>
              关于"{{ourSide}}与{{otherParty}}{{caseReason}}"案的风险评估报告
                  致：{{ourSide}}
                  日期：{{reportDate}}
                  案由：{{caseReason}}
                  一、 报告基础与声明
                  ...
                  二、 案件核心事实梳理
                  ...
                  三、 初步风险评估
                  ...
                  四、 行动建议与后续策略
                  ...
              </content>"

            ## 输出规范

            ### 格式要求
            - 使用 emoji 提升可读性
            - 使用列表、分点展示
            - 每个段落不超过 200 字
            - 重要信息用粗体标记
            - 使用分隔线区分不同部分

            ### 风险程度标记
            - 🚨 高风险 - 需要立即处理
            - ⚡ 中风险 - 建议尽快处理
            - ✅ 正常 - 风险可控
            - ℹ️ 提示 - 一般性说明

            ### 结构标记
            - 📊 数据/统计
            - 📄 文档/条款
            - 🔍 分析/发现
            - 💡 建议/提示
            - ⚠️ 警告/注意
            - ✓ 完成项

            ## 可用工具

            1. **getFileContent(fileId)** - 获取文件内容
               用途：读取用户上传的文档内容

            2. **getCurrentTime(timezone)** - 获取当前时间
               用途：获取报告日期

            ## 重要约束

            1. **不要一次性输出完整报告** - 除非用户明确要求
            2. **每轮回复控制在 5 个要点以内** - 避免信息过载
            3. **主动询问用户需求** - 不要自顾自地分析
            4. **使用用户能理解的语言** - 避免过多法律术语
            5. **记住用户已提供的信息** - 利用对话历史，不要重复询问

            ## 用户打断处理

            当用户说：
            - "跳过" → 跳过当前问题，进入下一步
            - "直接生成报告" / "生成报告" → 跳过后续流程，生成完整报告
            - "返回" → 返回上一个阶段
            - "补充XXX" → 记录补充信息

            ## 示例对话

            User: "我想评估合同风险"
            Assistant: "您好！我可以帮您进行交互式法律风险评估。

             请问您想评估什么？
             1. 合同风险
             2. 合规审查
             3. 诉讼风险

             您最关心哪些方面？"

            User: "合同风险，关心付款条款和违约责任"
            Assistant: "好的，请上传合同文档。"

            User: [上传文件]
            Assistant: "收到文档。让我先看看...
             [调用 getFileContent 工具]

             为了更准确地评估，我还需要了解：
             1. 这份合同的交易金额大概是多少？
             2. 您在交易中的角色是买方还是卖方？"

            User: "金额50万，我是买方"
            Assistant: "明白了。还有其他需要我了解的吗？"

            User: "没有了"
            Assistant: "📊 风险快速评估

             🚨 风险等级: 中等 (风险评分: 65/100)

             ⚠️ 关键发现:
             1. 付款条款存在风险 - 约定分3期但未明确具体日期
             2. 违约金比例约定不明确 - 可能导致追责困难
             3. 争议解决条款较完善 ✅

             您想深入了解哪个方面？还是继续评估其他风险点？"
            """;

    /**
     * 原有报告模式提示词（保留，用于向后兼容）
     */
    private static final String ORIGINAL_REPORT_PROMPT = """
            #你是专业法律风险评估师,基于案件材料进行客观、专业的风险分析。
            #前提：获取当前时间
            #核心原则
            - 基于材料分析,避免主观臆断
            - 使用专业术语,确保表述清晰
            - 严格遵守格式,不得遗漏字段
            ...
            [原有完整提示词]
            """;

    @Override
    protected double getDefaultTemperature() {
        return 0.7;  // 提高温度，增加交互灵活性
    }
}
```

### 5.3 传递参数到 Agent（可选）

```java
// 方案A: 通过 Conversation.parameters 传递
// ChatService.java

// 在 createChatStream 方法中
if (Boolean.TRUE.equals(request.getInteractiveMode())) {
    String params = "{\"interactiveMode\":true}";
    conversation.setParameters(params);
    conversationMapper.updateById(conversation);
}

// RiskAssessmentAgent.java
// 通过 Conversation 获取参数
// 需要注入 ConversationMapper
```

### 5.4 前端快捷操作（可选）

```jsx
// ChatInterface.jsx

const isRiskAssessment = agentType === 'RISK_ASSESSMENT';

{isRiskAssessment && (
  <div className="quick-actions">
    <button onClick={() => onSendMessage('跳过')}>
      ⏭️ 跳过此问题
    </button>
    <button onClick={() => onSendMessage('生成报告')}>
      📄 直接生成报告
    </button>
    <button onClick={() => onSendMessage('返回')}>
      🔙 返回上一步
    </button>
  </div>
)}
```

---

## 6. 前端配合

### 6.1 最小改动方案

前端可以不做任何改动，交互式评估自然通过对话进行。

### 6.2 增强方案（推荐）

#### 6.2.1 检测Agent类型

```jsx
const isRiskAssessment = conversation.agentType === 'risk_assessment';
```

#### 6.2.2 显示快捷操作

```jsx
{isRiskAssessment && (
  <div className="quick-actions-panel">
    <div className="quick-action-title">快捷操作</div>
    <QuickActionButton icon="⏭️" label="跳过" message="跳过" />
    <QuickActionButton icon="📄" label="生成报告" message="生成报告" />
    <QuickActionButton icon="🔙" label="返回" message="返回" />
  </div>
)}
```

#### 6.2.3 解析风险等级

```jsx
// 解析Agent响应中的风险等级
const parseRiskLevel = (content) => {
  if (content.includes('🚨')) return { level: '高', color: '#ff4444' };
  if (content.includes('⚡')) return { level: '中', color: '#ffbb33' };
  if (content.includes('✅')) return { level: '低', color: '#00C851' };
  return null;
};

// 显示风险卡片
{riskLevel && (
  <RiskCard level={riskLevel.level} color={riskLevel.color} />
)}
```

---

## 7. 测试验证

### 7.1 功能测试

| 测试场景 | 测试步骤 | 预期结果 |
|---------|---------|---------|
| 交互式流程 | 1. 发起风险评估<br>2. 逐步回答问题<br>3. 查看初步分析<br>4. 要求深入分析<br>5. 生成报告 | 每个阶段正常交互 |
| 跳过问题 | 在信息收集阶段点击"跳过" | 跳过当前问题，进入下一个 |
| 直接生成报告 | 在任意阶段说"生成报告" | 生成完整报告 |
| 多轮深入 | 多次要求深入分析不同方面 | 每次都提供不同方面的详细分析 |
| 会话恢复 | 关闭页面后重新打开同一会话 | 从上次中断的地方继续 |
| 原有模式 | 不传 interactiveMode 参数 | 保持原有一次性报告行为 |

### 7.2 兼容性测试

| 测试项 | 说明 |
|--------|------|
| 向后兼容 | 不传 interactiveMode 参数时，保持原有行为 |
| 多Agent | 其他Agent（法律咨询、争议焦点等）不受影响 |
| 现有功能 | 文件上传、知识库检索等功能正常 |

### 7.3 性能测试

| 指标 | 目标值 |
|------|--------|
| 响应时间 | < 3秒 |
| 并发用户 | > 100 |
| 会话存储 | > 30天 |

---

## 8. 部署方案

### 8.1 部署步骤

```bash
# 1. 备份现有代码
git checkout -b backup-before-interactive

# 2. 修改 RiskAssessmentAgent.java
# 3. 修改 ChatCompletionRequest.java
# 4. 可选：修改前端组件

# 5. 编译打包
mvn clean package -DskipTests

# 6. 部署
# 方式A: 直接部署
java -jar legal-assistant.jar

# 方式B: Docker部署
docker-compose up -d
```

### 8.2 回滚方案

```bash
# 如需回滚
git checkout backup-before-interactive
mvn clean package -DskipTests
# 重新部署
```

---

## 9. 优势对比

### 9.1 方案对比

| 维度 | 新增独立服务 | 基于现有架构 |
|------|-------------|-------------|
| 开发工作量 | 大（5-7天） | 小（1-2天） |
| 架构复杂度 | 增加 | 不变 |
| 维护成本 | 高 | 低 |
| 兼容性风险 | 有 | 无 |
| 部署难度 | 高 | 低 |
| 代码复用 | 少 | 高 |

### 9.2 技术优势

✅ **架构兼容**：完全基于现有架构，无需新增服务
✅ **最小改动**：只修改必要的代码，风险可控
✅ **向后兼容**：不影响现有功能和其他Agent
✅ **易于维护**：代码集中，便于后续优化
✅ **快速迭代**：可以快速调整提示词优化体验

---

## 10. 后续优化

### 10.1 短期优化（1-2周）

- [ ] 根据用户反馈调整提示词
- [ ] 优化交互流程节奏
- [ ] 增加更多快捷操作
- [ ] 支持更多文件类型

### 10.2 中期优化（1-2月）

- [ ] 新增风险评估专用工具
- [ ] 支持评估报告导出（PDF）
- [ ] 增加评估历史对比
- [ ] 支持评估模板保存

### 10.3 长期优化（3-6月）

- [ ] 引入知识图谱增强分析
- [ ] 支持批量文档评估
- [ ] 增加协作评估功能
- [ ] AI助手建议优化

---

## 11. 附录

### 11.1 完整交互提示词

见上文 `INTERACTIVE_SYSTEM_PROMPT`

### 11.2 风险评估报告模板

见原有 `ORIGINAL_REPORT_PROMPT`

### 11.3 常见问题

**Q: 会不会影响现有用户？**
A: 不会。新增的 `interactiveMode` 参数默认为 `false`，保持原有行为。

**Q: 如何判断用户想要生成报告？**
A: 通过关键词匹配：生成报告、完整报告、出具报告、好的、可以、OK等。

**Q: 如何处理用户中途退出？**
A: 现有会话机制会自动保存对话历史，用户可以随时恢复。

**Q: 能否支持多文档评估？**
A: 可以。现有的 `fileIds` 参数支持传入多个文件ID。

---

**文档结束**

**关键要点：**
1. ✅ 完全基于现有架构
2. ✅ 最小化代码改动
3. ✅ 向后兼容
4. ✅ 快速实施（1-2天）
5. ✅ 风险可控
